<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HVACç›‘æ§é¢æ¿</title>
    <style>
        :root {
            --primary-color: #3498db;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --dark-color: #2c3e50;
            --light-color: #ecf0f1;
            --gray-color: #95a5a6;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1300px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary-color), var(--dark-color));
            color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .time-display {
            margin-top: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            display: inline-block;
            width: 80%;
            max-width: 600px;
        }
        
        .current-time {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .time-navigation {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 10px;
        }

        
        .time-selector {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            margin-bottom: 10px;
            
        }

        .time-selector label{
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .time-selector select {
            padding: 8px 12px;
            border-radius: 5px;
            border: none;
            background-color: white;
            color: var(--dark-color);
            font-size: 1.2rem;
            font-weight: bold;
            min-width: 200px;
            cursor: pointer;
        }
        
        .time-selector select:focus {
            outline: 2px solid var(--primary-color);
        }
        
        .auto-update-indicator {
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 0.85rem;
        }
        
        .update-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--success-color);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        
        .card-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--dark-color);
        }
        
        .icon {
            margin-right: 10px;
            font-size: 1.5rem;
        }
        
        .mode-indicator {
            display: flex;
            justify-content: space-around;
            margin: 15px 0;
        }
        
        .mode {
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            flex: 1;
            margin: 0 5px;
        }
        
        .mode.active {
            background-color: var(--success-color);
            color: white;
        }
        
        .mode.inactive {
            background-color: var(--gray-color);
            color: white;
        }
        
        .heartbeat-container {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }
        
        .heartbeat {
            text-align: center;
            position: relative;
        }
        
        .heartbeat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
            margin: 10px 0;
        }
        
        .heartbeat-label {
            font-size: 0.9rem;
            color: var(--gray-color);
        }
        
        .priority-grid, .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .priority-item, .status-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 5px;
            background-color: var(--light-color);
        }
        
        .priority-badge {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .priority-1 { background-color: var(--success-color); }
        .priority-2 { background-color: var(--warning-color); }
        .priority-3 { background-color: var(--danger-color); }
        
        .status-item.active {
            background-color: var(--success-color);
            color: white;
        }
        
        .status-item.inactive {
            background-color: var(--gray-color);
            color: white;
        }
        
        .device-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .device-table th, .device-table td {
            padding: 12px 15px;
            min-width: 78px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .device-table th {
            background-color: var(--light-color);
            font-weight: 600;
        }
        
        .device-table tr:hover {
            background-color: #f9f9f9;
        }
        
        .status-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .status-online {
            background-color: var(--success-color);
            color: white;
        }
        
        .status-offline {
            background-color: var(--gray-color);
            color: white;
        }
        
        .status-warning {
            background-color: var(--warning-color);
            color: white;
        }
        
        .temperature-gauge {
            height: 10px;
            background-color: #eee;
            border-radius: 5px;
            margin-top: 5px;
            overflow: hidden;
        }
        
        .temperature-fill {
            height: 100%;
            border-radius: 5px;
            background: linear-gradient(90deg, #3498db, #e74c3c);
        }
        
        .data-row {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding-bottom: 10px;
            border-bottom: 1px dashed #eee;
        }
        
        .data-label {
            font-weight: 600;
            color: var(--dark-color);
        }
        
        .data-value {
            color: var(--primary-color);
            font-weight: 500;
        }
        
        .temperature-container {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
        }
        
        .temperature-box {
            text-align: center;
            flex: 1;
            padding: 10px;
            border-radius: 5px;
            background-color: var(--light-color);
            margin: 0 5px;
        }
        
        .temperature-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .temperature-label {
            font-size: 0.8rem;
            color: var(--gray-color);
        }
        
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .priority-grid, .status-grid {
                grid-template-columns: 1fr;
            }
            
            .mode-indicator, .heartbeat-container {
                flex-direction: column;
            }
            
            .mode, .heartbeat {
                margin: 5px 0;
            }
            
            .time-selector {
                flex-direction: column;
            }
            
            .time-selector select {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>HVACç›‘æ§é¢æ¿</h1>
            <p>å®æ—¶ç›‘æ§å†·æ°´æœºç»„ã€å†·å‡æ³µå’Œå†·å´å¡”ç³»ç»ŸçŠ¶æ€</p>
            <div class="time-display">
                <!-- <div class="current-time" id="current-time">æ­£åœ¨åŠ è½½æ•°æ®...</div> -->
                <div class="time-selector">
                    <label for="time-select">é€‰æ‹©æ•°æ®æ—¶é—´ç‚¹ï¼š</label>
                    <select id="time-select">
                        <option value="">åŠ è½½ä¸­...</option>
                    </select>
                </div>
                <div class="time-navigation" id="time-navigation">ä½¿ç”¨é”®ç›˜ â†‘â†“ é”®æˆ–ä¸‹æ‹‰åˆ—è¡¨åˆ‡æ¢æ—¶é—´ç‚¹</div>
                <div class="auto-update-indicator">
                    <div class="update-dot"></div>
                    <span>æ•°æ®æ¯30ç§’è‡ªåŠ¨æ›´æ–°</span>
                </div>
            </div>
        </header>
        
        <div class="dashboard">
            <!-- ç³»ç»Ÿæ¨¡å¼å¡ç‰‡ -->
            <div class="card">
                <div class="card-header">
                    <div class="icon">âš™ï¸</div>
                    <h2 class="card-title">ç³»ç»Ÿæ§åˆ¶æ¨¡å¼</h2>
                </div>
                <div class="mode-indicator">
                    <div class="mode inactive" id="optimization-mode">
                        <div>ä¼˜åŒ–æ¨¡å¼</div>
                        <div>å·²å…³é—­</div>
                    </div>
                    <div class="mode inactive" id="winter-mode">
                        <div>å†¬å­£æ¨¡å¼</div>
                        <div>å·²å…³é—­</div>
                    </div>
                </div>
            </div>
            
            <!-- å¿ƒè·³æ•°æ®å¡ç‰‡  -->
            <div class="card">
                <div class="card-header">
                    <div class="icon">â¤ï¸</div>
                    <h2 class="card-title">ç³»ç»Ÿå¿ƒè·³</h2>
                </div>
                <div class="heartbeat-container">
                    <div class="heartbeat">
                        <div class="heartbeat-label">PLCå¿ƒè·³</div>
                        <div class="heartbeat-value" id="heartbeat-1">-</div>
                    </div>
                    <div class="heartbeat">
                        <div class="heartbeat-label">AIå¿ƒè·³</div>
                        <div class="heartbeat-value" id="heartbeat-2">-</div>
                    </div>
                </div>
            </div>
            
            <!-- è¯·æ±‚çŠ¶æ€å¡ç‰‡ -->
            <div class="card">
                <div class="card-header">
                    <div class="icon">ğŸ“¡</div>
                    <h2 class="card-title">è®¾å¤‡è¯·æ±‚æ•°é‡</h2>
                </div>
                <div class="status-grid" id="request-status">
                    <!-- è¯·æ±‚çŠ¶æ€å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
        
        <!-- å†·æ°´æœºç»„çŠ¶æ€è¡¨æ ¼ -->
        <div class="card">
            <div class="card-header">
                <div class="icon">â„ï¸</div>
                <h2 class="card-title">å†·æ°´æœºç»„çŠ¶æ€</h2>
            </div>
            <div class="device-table-container">
                <table class="device-table">
                    <thead>
                        <tr>
                            <th>è®¾å¤‡ID</th>
                            <th>çŠ¶æ€</th>
                            <th>è´Ÿè½½</th>
                            <th>ä¼˜å…ˆçº§</th>
                            <th>è‡ªåŠ¨çŠ¶æ€</th>
                            <th>æ§åˆ¶çŠ¶æ€</th>
                            <th>æ•…éšœçŠ¶æ€</th>
                            <th>å›æ°´æ¸©åº¦</th>
                            <th>ä¾›æ°´æ¸©åº¦</th>
                            <th>è®¾å®šæ¸©åº¦</th>
                            <th>å†·å‡æ°´å‡ºæ°´æ¸©åº¦</th>
                            <th>å†·å‡æ°´å›æ°´æ¸©åº¦</th>
                        </tr>
                    </thead>
                    <tbody id="chiller-table-body">
                        <!-- å†·æ°´æœºç»„æ•°æ®å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- å†·å‡æ³µçŠ¶æ€è¡¨æ ¼ -->
        <div class="card">
            <div class="card-header">
                <div class="icon">ğŸ’§</div>
                <h2 class="card-title">å†·å‡æ³µçŠ¶æ€</h2>
            </div>
            <div class="device-table-container">
                <table class="device-table">
                    <thead>
                        <tr>
                            <th>è®¾å¤‡ID</th>
                            <th>çŠ¶æ€</th>
                            <th>ä¼˜å…ˆçº§</th>
                            <th>è‡ªåŠ¨çŠ¶æ€</th>
                            <th>æ§åˆ¶çŠ¶æ€</th>
                            <th>æ•…éšœçŠ¶æ€</th>
                            <th>é€Ÿåº¦</th>
                        </tr>
                    </thead>
                    <tbody id="condenser-pump-table-body">
                        <!-- å†·å‡æ³µæ•°æ®å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- å†·å´å¡”çŠ¶æ€è¡¨æ ¼ -->
        <div class="card">
            <div class="card-header">
                <div class="icon">ğŸŒ¡ï¸</div>
                <h2 class="card-title">å†·å´å¡”çŠ¶æ€</h2>
            </div>
            <div class="device-table-container">
                <table class="device-table">
                    <thead>
                        <tr>
                            <th>è®¾å¤‡ID</th>
                            <th>çŠ¶æ€</th>
                            <th>ä¼˜å…ˆçº§</th>
                            <th>è‡ªåŠ¨çŠ¶æ€</th>
                            <th>æ§åˆ¶çŠ¶æ€</th>
                            <th>æ•…éšœçŠ¶æ€</th>
                            <th>é€Ÿåº¦</th>
                        </tr>
                    </thead>
                    <tbody id="cooling-tower-table-body">
                        <!-- å†·å´å¡”æ•°æ®å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let groupedData = {};
        let currentTimeKeys = [];
        let currentTimeIndex = 0;
        let lastUpdateTime = null;
        let updateInterval = null;

        // InfluxDBé…ç½®
        const INFLUX_CONFIG = {
            url: 'https://influxdb2.cloud-building.com',
            token: 'X3VOqa8nUqoDlh5aaSBtIYdnl2pN_H30eQh6uhEI6AivgRO1aCkjoCqOnDNFFPnjaU43yTHeoszwCiMvMhTc2g==',
            org: 'sysOrg',
            bucket: 'Buckets_saas_test_yin'
        };

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            // è·å–å¹¶æ›´æ–°æ‰€æœ‰æ•°æ®
            fetchDataFromInflux();
            
            // æ·»åŠ é”®ç›˜äº‹ä»¶ç›‘å¬
            document.addEventListener('keydown', handleKeyDown);
            
            // æ·»åŠ ä¸‹æ‹‰åˆ—è¡¨äº‹ä»¶ç›‘å¬
            document.getElementById('time-select').addEventListener('change', handleTimeSelectChange);
            
            // å¯åŠ¨30ç§’å¢é‡æ›´æ–°
            startIncrementalUpdate();
        });

        // å¯åŠ¨å¢é‡æ›´æ–°
        function startIncrementalUpdate() {
            // æ¸…é™¤ç°æœ‰å®šæ—¶å™¨
            if (updateInterval) {
                clearInterval(updateInterval);
            }
            
            // æ¯30ç§’æ›´æ–°ä¸€æ¬¡æ•°æ®
            updateInterval = setInterval(async () => {
                await incrementalUpdate();
            }, 30000);
        }

        // å¢é‡æ›´æ–°æ•°æ®
        async function incrementalUpdate() {
            try {
                console.log('æ‰§è¡Œå¢é‡æ›´æ–°...');
                
                // è·å–æœ€æ–°æ•°æ®ï¼ˆä»…è·å–æœ€è¿‘å‡ åˆ†é’Ÿçš„æ•°æ®ï¼‰
                const query = `
                    from(bucket: "${INFLUX_CONFIG.bucket}")
                        |> range(start: -1m)
                        |> filter(fn: (r) => r["_measurement"] =~ /^device_mqttpayload_data_/ and not r["_measurement"] =~ /^device_mqttpayload_data_PM_/ and r["_field"] != "write_time")
                        |> keep(columns: ["_time", "_measurement", "_value"])
                        |> group(columns: ["_time"])
                        |> sort(columns: ["_time", "_measurement"])
                `;
                
                const newData = await fetchFluxData(query);
                
                if (!newData || newData.length === 0) {
                    console.log('æ²¡æœ‰è·å–åˆ°æ–°æ•°æ®');
                    return;
                }
                
                // æŒ‰æ—¶é—´åˆ†ç»„æ–°æ•°æ®
                const newGroupedData = groupDataByTime(newData);
                
                // åˆå¹¶åˆ°ç°æœ‰æ•°æ®ä¸­
                Object.keys(newGroupedData).forEach(timeKey => {
                    // å¦‚æœè¿™ä¸ªæ—¶é—´ç‚¹å·²å­˜åœ¨ï¼Œæ›´æ–°æ•°æ®ï¼›å¦åˆ™æ·»åŠ æ–°æ—¶é—´ç‚¹
                    groupedData[timeKey] = newGroupedData[timeKey];
                });
                
                // æ›´æ–°å¯ç”¨æ—¶é—´ç‚¹åˆ—è¡¨
                currentTimeKeys = Object.keys(groupedData).sort().reverse();
                
                // å¦‚æœå½“å‰é€‰ä¸­çš„æ˜¯æœ€æ–°æ•°æ®ï¼Œåˆ™è‡ªåŠ¨æ›´æ–°åˆ°æœ€æ–°
                if (currentTimeIndex === 0) {
                    // é‡æ–°è®¡ç®—å½“å‰ç´¢å¼•ï¼ˆå› ä¸ºå¯èƒ½æœ‰æ–°çš„æ—¶é—´ç‚¹åŠ å…¥ï¼‰
                    currentTimeIndex = 0;
                    updateTimeDisplay();
                    updateTimeSelect();
                    updateUIData(groupedData[currentTimeKeys[currentTimeIndex]]);
                } else {
                    // å¦‚æœä¸æ˜¯æœ€æ–°æ•°æ®ï¼Œåªæ›´æ–°æ—¶é—´ä¸‹æ‹‰åˆ—è¡¨ï¼Œä¿æŒå½“å‰è§†å›¾
                    updateTimeSelect();
                }
                
                // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
                lastUpdateTime = new Date();
                console.log('å¢é‡æ›´æ–°å®Œæˆ');
                
            } catch (error) {
                console.error('å¢é‡æ›´æ–°å¤±è´¥:', error);
            }
        }

        // é”®ç›˜äº‹ä»¶å¤„ç†
        function handleKeyDown(event) {
            if (currentTimeKeys.length <= 1) return;
            
            switch(event.key) {
                case 'ArrowUp':
                    event.preventDefault();
                    if (currentTimeIndex < currentTimeKeys.length - 1) {
                        currentTimeIndex++;
                        updateTimeDisplay();
                        updateUIData(groupedData[currentTimeKeys[currentTimeIndex]]);
                        updateTimeSelect();
                    }
                    break;
                case 'ArrowDown':
                    event.preventDefault();
                    if (currentTimeIndex > 0) {
                        currentTimeIndex--;
                        updateTimeDisplay();
                        updateUIData(groupedData[currentTimeKeys[currentTimeIndex]]);
                        updateTimeSelect();
                    }
                    break;
            }
        }

        // æ—¶é—´é€‰æ‹©ä¸‹æ‹‰åˆ—è¡¨äº‹ä»¶å¤„ç†
        function handleTimeSelectChange(event) {
            const selectedTime = event.target.value;
            if (selectedTime && groupedData[selectedTime]) {
                currentTimeIndex = currentTimeKeys.indexOf(selectedTime);
                updateTimeDisplay();
                updateUIData(groupedData[selectedTime]);
            }
        }

        // æ›´æ–°æ—¶é—´æ˜¾ç¤º
        function updateTimeDisplay() {
            const currentTimeElement = document.getElementById('current-time');
            const timeNavigationElement = document.getElementById('time-navigation');
            
            if (currentTimeKeys.length > 0) {
                const currentTime = currentTimeKeys[currentTimeIndex];
                //currentTimeElement.textContent = `æ•°æ®æ—¶é—´: ${currentTime}`;
                timeNavigationElement.textContent = `ä½¿ç”¨é”®ç›˜ â†‘â†“ é”®æˆ–ä¸‹æ‹‰åˆ—è¡¨åˆ‡æ¢æ—¶é—´ç‚¹ (${currentTimeIndex + 1}/${currentTimeKeys.length})`;
            } else {
                //currentTimeElement.textContent = 'æš‚æ— æ•°æ®';
                timeNavigationElement.textContent = '';
            }
        }

        // æ›´æ–°ä¸‹æ‹‰åˆ—è¡¨é€‰é¡¹
        function updateTimeSelect() {
            const timeSelect = document.getElementById('time-select');
            timeSelect.innerHTML = '';
            
            currentTimeKeys.forEach((time, index) => {
                const option = document.createElement('option');
                option.value = time;
                option.textContent = time;
                if (index === currentTimeIndex) {
                    option.selected = true;
                }
                timeSelect.appendChild(option);
            });
        }

        // ä»InfluxDBè·å–æ•°æ®
        async function fetchDataFromInflux() {
            try {
                // è·å–ç³»ç»Ÿæ¨¡å¼æ•°æ®
                const chillerQuery = await fetchFluxData(`
                    from(bucket: "${INFLUX_CONFIG.bucket}")
                        |> range(start: -2d)
                        |> filter(fn: (r) => r["_measurement"] =~ /^device_mqttpayload_data_/ and not r["_measurement"] =~ /^device_mqttpayload_data_PM_/)
                        |> keep(columns: ["_time", "_measurement", "_value"])
                        |> group(columns: ["_time"])
                        |> sort(columns: ["_time", "_measurement"])
                `);
                
                // æŒ‰æ—¶é—´åˆ†ç»„æ•°æ®
                groupedData = groupDataByTime(chillerQuery);
                console.log('æŒ‰æ—¶é—´åˆ†ç»„çš„æ•°æ®:', groupedData);
                
                // è·å–æ‰€æœ‰æ—¶é—´ç‚¹å¹¶æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
                currentTimeKeys = Object.keys(groupedData).sort().reverse();
                currentTimeIndex = 0; // é»˜è®¤æ˜¾ç¤ºæœ€æ–°çš„æ•°æ®
                
                // æ›´æ–°UI
                updateTimeDisplay();
                updateTimeSelect();
                updateUIData(groupedData[currentTimeKeys[currentTimeIndex]]);
                
            } catch (error) {
                console.error('Error fetching data from InfluxDB:', error);
                // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ä½œä¸ºåå¤‡
                //useMockData();
            }
        }

        // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
        function useMockData() {
            // ç”Ÿæˆæ¨¡æ‹Ÿçš„æ—¶é—´ç‚¹
            const now = new Date();
            const mockTimes = [];
            
            for (let i = 0; i < 5; i++) {
                const time = new Date(now.getTime() - i * 60000); // æ¯åˆ†é’Ÿä¸€ä¸ªæ•°æ®ç‚¹
                const formattedTime = time.toISOString().replace('T', ' ').substring(0, 19);
                mockTimes.push(formattedTime);
                
                // ä¸ºæ¯ä¸ªæ—¶é—´ç‚¹åˆ›å»ºæ¨¡æ‹Ÿæ•°æ®
                groupedData[formattedTime] = JSON.parse(JSON.stringify(systemData));
                
                // ä¸ºä¸åŒæ—¶é—´ç‚¹æ·»åŠ ä¸€äº›å˜åŒ–
                if (i > 0) {
                    groupedData[formattedTime].systemControls.w_heartbeat_1 = Math.floor(Math.random() * 100) + 400;
                    groupedData[formattedTime].systemControls.w_heartbeat_2 = Math.floor(Math.random() * 20) + 30;
                }
            }
            
            currentTimeKeys = mockTimes;
            currentTimeIndex = 0;
            
            // æ›´æ–°UI
            updateTimeDisplay();
            updateTimeSelect();
            updateUIData(groupedData[currentTimeKeys[currentTimeIndex]]);
        }

        const fetchFluxData = async (fluxQuery) => {
            const url = new URL('https://cbosv3-sandbox.cloud-building.com/api/v1/internal/query')
            const organization = '55'
            const token =
                'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjI3IiwiaWRUeXBlIjoiYXBwbGljYXRpb24iLCJpYXQiOjE3NDc1NTcwNjA3NDcsImV4cGlyZSI6MjA2MjkxNzA2MDc0N30.MDj5wYRk461YZdyC53zljEFR9GklXVYAEugrlleiyz0'

            // è®¾ç½® URL å‚æ•°
            url.searchParams.append('fluxQuery', fluxQuery)

            const response = await fetch(url, {
                headers: {
                accept: 'application/json', // æŒ‡å®šè¿”å› JSON æ ¼å¼
                organization, // ç»„ç»‡ ID
                Authorization: `Bearer ${token}`,
                },
            })

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`)
            }

            // è·å–æ•°æ®
            const data = await response.json()
            return data.data
        }

        // æŒ‰æ—¶é—´åˆ†ç»„æ•°æ®çš„å‡½æ•°
        function groupDataByTime(data) {
            const grouped = {};
            
            data.forEach(item => {
                //å°† UTC æ—¶é—´å­—ç¬¦ä¸²è½¬æ¢ä¸ºä¸œå…«åŒºæ—¶é—´
                const time = formatToChinaTime(item._time);
                if (!grouped[time]) {
                    grouped[time] = {};
                }
                // ä»¥_measurementä¸ºé”®ï¼Œ_valueä¸ºå€¼å­˜å‚¨
                const itemKey = item._measurement.replace('device_mqttpayload_data_', '');
                grouped[time][itemKey] = item._value;
            });
            
            const formattedData = {};
            Object.keys(grouped).forEach(key => {
                const value = grouped[key];
                const data = structureByDeviceType(value);
                formattedData[key] = data;
            });
            return formattedData;
        }

        // ç»“æ„åŒ–jsonå¯¹è±¡
        function structureByDeviceType(data) {
            const structured = {
                // å†·æ°´æœºç»„ç›¸å…³
                chillers: {},
                // å†·å´æ°´æ³µç›¸å…³
                condenserPumps: {},
                // å†·å†»æ°´æ³µç›¸å…³
                chilledWaterPumps: {},
                // å†·å´å¡”ç›¸å…³
                coolingTowers: {},
                // ç³»ç»Ÿæ¨¡å¼å’Œå¿ƒè·³
                systemControls: {},
                // ä¼˜å…ˆçº§è®¾ç½®
                priorities: {},
                // Requestå’ŒçŠ¶æ€
                status: {}
            };

            Object.keys(data).forEach(key => {
                const value = data[key];
            
                // å†·æ°´æœºç»„ (CH)  
                if ((key.startsWith('CH') && !key.startsWith('CHWP')) || key.startsWith('w_CH_')) {
                let chKey = key.replace(/^(w_)?CH_/, '');
                //è¿™æ ·åªä¼šåˆ é™¤"CH"éƒ¨åˆ†ï¼Œä¿ç•™åé¢çš„æ•°å­—
                chKey = chKey.replace(/^CH(?=\d)/, '');
                if (chKey.includes('_')) {
                        const [device, ...rest] = chKey.split('_');
                        const devicename = 'CH_' + device;
                        if (!structured.chillers[devicename]) 
                        structured.chillers[devicename] = {};
                        structured.chillers[devicename][rest.join('_')] = value;
                    } else {
                        structured.chillers[chKey] = value;
                    }
                }
                // å†·å´æ°´æ³µ (CDWP)
                else if (key.startsWith('CDWP_') || key.startsWith('w_CDWP_')) {
                    const pumpKey = key.replace(/^(w_)?CDWP_/, '');
                    if (pumpKey.includes('_')) {
                        const [device, ...rest] = pumpKey.split('_');
                        const devicename = 'CDWP_' + device;
                        if (!structured.condenserPumps[devicename]) 
                        structured.condenserPumps[devicename] = {};
                        structured.condenserPumps[devicename][rest.join('_')] = value;
                    } else {
                        structured.condenserPumps[pumpKey] = value;
                    }
                }
                // å†·å†»æ°´æ³µ (CHWP)
                else if (key.startsWith('CHWP_')) {
                    const pumpKey = key.replace('CHWP_', '');
                    if (pumpKey.includes('_')) {
                        const [device, ...rest] = pumpKey.split('_');
                        const devicename = 'CHWP_' + device;
                        if (!structured.chilledWaterPumps[devicename]) 
                        structured.chilledWaterPumps[devicename] = {};
                        structured.chilledWaterPumps[devicename][rest.join('_')] = value;
                    } else {
                        structured.chilledWaterPumps[pumpKey] = value;
                    }
                }
                // å†·å´å¡” (CT)
                else if (key.startsWith('CT_') || key.startsWith('w_CT_')) {
                const ctkey = key.replace(/^(w_)?CT_/, '');
                if (ctkey.includes('_')) {
                        const [device, ...rest] = ctkey.split('_');
                        const devicename = 'CT_' + device;
                        if (!structured.coolingTowers[devicename]) 
                        structured.coolingTowers[devicename] = {};
                        structured.coolingTowers[devicename][rest.join('_')] = value;
                    } else {
                        structured.coolingTowers[ctkey] = value;
                    }
                }
                // ç³»ç»Ÿæ§åˆ¶
                else if (key.startsWith('b_') || key.startsWith('w_heartbeat')) {
                    structured.systemControls[key] = value;
                }
                else {
                    structured.status[key] = value;
                }

                // ä¼˜å…ˆçº§
                if (key.startsWith('w_') && key.includes('Priority')) {
                    structured.priorities[key] = value;
                }
                // è¯·æ±‚çŠ¶æ€
                else if (key.startsWith('w_') && key.includes('Request')) {
                    structured.status[key] = value;
                }
            });

            return structured;
        }

        // å°† UTC æ—¶é—´å­—ç¬¦ä¸²è½¬æ¢ä¸ºä¸œå…«åŒºæ—¶é—´çš„å‡½æ•°
        function formatToChinaTime(utcTimeString) {
            // åˆ›å»º Date å¯¹è±¡ï¼ˆä¼šè‡ªåŠ¨è¯†åˆ«ä¸º UTC æ—¶é—´ï¼‰
            const utcDate = new Date(utcTimeString);
            
            // è½¬æ¢ä¸ºä¸œå…«åŒºæ—¶é—´ï¼ˆUTC+8ï¼‰
            const chinaTime = new Date(utcDate.getTime() + 8 * 60 * 60 * 1000);
            
            // æ ¼å¼åŒ–ä¸ºæœ¬åœ°æ—¶é—´å­—ç¬¦ä¸²
            const formattedTime = chinaTime.toISOString().replace('T', ' ').substring(0, 19);
            
            return formattedTime;
        }

        // æ›´æ–°UIæ•°æ®
        function updateUIData(data) {
            // è®¾ç½®ç³»ç»Ÿæ¨¡å¼
            document.getElementById('optimization-mode').className = 
                data.systemControls.b_Optimization_Mode ? 'mode active' : 'mode inactive';
            document.getElementById('winter-mode').className = 
                data.systemControls.b_Winter_Mode ? 'mode active' : 'mode inactive';
            
            // è®¾ç½®å¿ƒè·³æ•°æ®
            document.getElementById('heartbeat-1').textContent = data.systemControls.w_heartbeat_1;
            document.getElementById('heartbeat-2').textContent = data.systemControls.w_heartbeat_2;
            
            // ç”Ÿæˆè¯·æ±‚çŠ¶æ€
            const requestStatusContainer = document.getElementById('request-status');
            requestStatusContainer.innerHTML = '';
            for (const [key, value] of Object.entries(data.status)) {
                const statusItem = document.createElement('div');
                statusItem.className = value ? 'status-item active' : 'status-item inactive';
                statusItem.innerHTML = `
                    <div>${key.replace('w_', '').replace('_Request', ' : ')}</div>
                    <div>${value}</div>
                `;
                requestStatusContainer.appendChild(statusItem);
            }
            
            // ç”Ÿæˆå†·æ°´æœºç»„è¡¨æ ¼æ•°æ®
            let formattedData = [];
            Object.keys(data.chillers).forEach(key => {
                const obj = data.chillers[key];
                // chwpçš„ auto,tripä½œä¸ºCHçš„auto,trip
                const chwpKey = key.replace('CH_', 'CHWP_');
                const chwpObj = data.chilledWaterPumps[chwpKey];
                if (!obj) return;
                if (Object.keys(obj).length < 5) return;
                const formattedObj = {
                    id: key,
                    status: obj.Current_Draw,
                    load: obj.Current_Draw,
                    priority: obj.Priority,
                    auto: chwpObj ? chwpObj.Auto_Sta : 0,
                    trip: chwpObj ? chwpObj.Trip : 0,
                    control: obj.Control,
                    supplyTemp: obj.CHWS_Temp ? parseFloat(obj.CHWS_Temp).toFixed(1) : null,
                    returnTemp: obj.CHWR_Temp ? parseFloat(obj.CHWR_Temp).toFixed(1) : null,
                    setTemp: obj.CHWST_SP ? parseFloat(obj.CHWST_SP).toFixed(1) : null,
                    CDWS_Temp: obj.CDWS_Temp ? parseFloat(obj.CDWS_Temp).toFixed(1) : null,
                    CDWR_Temp: obj.CDWR_Temp ? parseFloat(obj.CDWR_Temp).toFixed(1) : null
                }
                formattedData.push(formattedObj);
            });
            const chillerTableBody = document.getElementById('chiller-table-body');
            chillerTableBody.innerHTML = '';
            formattedData.forEach(chiller => {
                const row = document.createElement('tr');
                if (!chiller.status) 
                    row.bgColor = '#ecf0f1';
                row.innerHTML = `
                    <td>${chiller.id}</td>
                    <td><span class="status-badge ${chiller.status ? 'status-online' : 'status-offline'}">${chiller.status ? 'è¿è¡Œ' : 'åœæ­¢'}</span></td>
                    <td>${chiller.load > 0 ? Math.round(chiller.load) + '%' : '-'}</td>
                    <td><span class="priority-badge priority-${chiller.priority}">${chiller.priority}</span></td>
                    <td>${chiller.auto ? 'è‡ªåŠ¨' : 'æ‰‹åŠ¨'}</td>
                    <td>${chiller.control ? 'å—æ§' : 'æœªæ§'}</td>
                    <td><span class="status-badge ${chiller.trip ? 'status-warning' : 'status-online'}">${chiller.trip ? 'æ•…éšœ' : 'æ­£å¸¸'}</span></td>

                    <td>${chiller.returnTemp ? chiller.returnTemp + 'Â°C' : 'N/A'}</td>
                    <td>${chiller.supplyTemp ? chiller.supplyTemp + 'Â°C' : 'N/A'}</td>
                    <td>${chiller.setTemp ? chiller.setTemp + 'Â°C' : 'N/A'}</td>
                    <td>${chiller.CDWS_Temp ? chiller.CDWS_Temp + 'Â°C' : 'N/A'}</td>
                    <td>${chiller.CDWR_Temp ? chiller.CDWR_Temp + 'Â°C' : 'N/A'}</td>
                `;
                chillerTableBody.appendChild(row);
            });
            
            // ç”Ÿæˆå†·å‡æ³µè¡¨æ ¼æ•°æ®
            formattedData = [];
            Object.keys(data.condenserPumps).forEach(key => {
                const obj = data.condenserPumps[key];
                if (!obj) return;
                if (Object.keys(obj).length < 5) return;
                const formattedObj = {
                    id: key,
                    status: obj.OnOff_Sta,
                    priority: obj.Priority,
                    auto: obj.Auto_Sta,
                    trip: obj.Trip,
                    control: obj.Control,
                    speed: obj.Speed_Control,
                }
                formattedData.push(formattedObj);
            });
            
            const condenserPumpTableBody = document.getElementById('condenser-pump-table-body');
            condenserPumpTableBody.innerHTML = '';
            formattedData.forEach(pump => {
                const row = document.createElement('tr');
                if (!pump.status) 
                    row.bgColor = '#ecf0f1';
                row.innerHTML = `
                    <td>${pump.id}</td>
                    <td><span class="status-badge ${pump.status ? 'status-online' : 'status-offline'}">${pump.status ? 'è¿è¡Œ' : 'åœæ­¢'}</span></td>
                    <td><span class="priority-badge priority-${pump.priority}">${pump.priority}</span></td>
                    <td>${pump.auto ? 'è‡ªåŠ¨' : 'æ‰‹åŠ¨'}</td>
                    <td>${pump.control ? 'å—æ§' : 'æœªæ§'}</td>
                    <td><span class="status-badge ${pump.trip ? 'status-warning' : 'status-online'}">${pump.trip ? 'æ•…éšœ' : 'æ­£å¸¸'}</span></td>
                    <td>${(pump.speed > 0 && pump.status) ? pump.speed + ' RPM' : '-'}</td>
                `;
                condenserPumpTableBody.appendChild(row);
            });
            
            // ç”Ÿæˆå†·å´å¡”è¡¨æ ¼æ•°æ®
            formattedData = [];
            Object.keys(data.coolingTowers).forEach(key => {
                const obj = data.coolingTowers[key];
                if (!obj) return;
                if (Object.keys(obj).length < 5) return;
                const formattedObj = {
                    id: key,
                    status: obj.OnOff_Sta,
                    priority: obj.Priority,
                    auto: obj.Auto_Sta,
                    trip: obj.Trip,
                    control: obj.Control,
                    speed: obj.Speed_Control,
                }
                formattedData.push(formattedObj);
            });
            
            const coolingTowerTableBody = document.getElementById('cooling-tower-table-body');
            coolingTowerTableBody.innerHTML = '';
            formattedData.forEach(tower => {
                const row = document.createElement('tr');
                if (!tower.status) 
                    row.bgColor = '#ecf0f1';
                row.innerHTML = `
                    <td>${tower.id}</td>
                    <td><span class="status-badge ${tower.status ? 'status-online' : 'status-offline'}">${tower.status ? 'è¿è¡Œ' : 'åœæ­¢'}</span></td>
                    <td><span class="priority-badge priority-${tower.priority}">${tower.priority}</span></td>
                    <td>${tower.auto ? 'è‡ªåŠ¨' : 'æ‰‹åŠ¨'}</td>
                    <td>${tower.control ? 'å—æ§' : 'æœªæ§'}</td>
                    <td><span class="status-badge ${tower.trip ? 'status-warning' : 'status-online'}">${tower.trip ? 'æ•…éšœ' : 'æ­£å¸¸'}</span></td>
                    <td>${(tower.speed > 0 && tower.status)? tower.speed + ' RPM' : '-'}</td>
                `;
                coolingTowerTableBody.appendChild(row);
            });
        }

        // æ¨¡æ‹Ÿæ•°æ® - åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™åº”è¯¥æ¥è‡ªInfluxDB APIè°ƒç”¨
        const systemData = {
            "chillers": {
                "CH_1": {
                    "CDWR_Temp": 31.941248,
                    "CDWS_Temp": 31.830151,
                    "CHWR_Temp": 17.998199,
                    "CHWST_SP": 10.5,
                    "CHWST_SP_Control": 10.5,
                    "CHWS_Temp": 16.053949,
                    "COND_SAT_Pressure": 411.619568,
                    "COND_SAT_Temp": 16.553898,
                    "Comp_A_Current": 0,
                    "Comp_B_Current": 0,
                    "Comp_C_Current": 0,
                    "Current_Draw": 0,
                    "Demand_Limit_SP": 95,
                    "EVAP_SAT_Pressure": 410.930084,
                    "EVAP_SAT_Temp": 16.49835,
                    "Running_Current": 0,
                    "CHW_Valve_Control": 0,
                    "CHW_Valve_Sta": 0,
                    "Control": 0,
                    "Priority": 2
                },
                "CH_3": {
                    "CDWR_Temp": 31.885698,
                    "CDWS_Temp": 37.940651,
                    "CHWR_Temp": 12.05435,
                    "CHWST_SP": 9.2,
                    "CHWST_SP_Control": 9.2,
                    "CHWS_Temp": 8.9991,
                    "COND_SAT_Pressure": 1021.809387,
                    "COND_SAT_Temp": 43.717846,
                    "Comp_A_Current": 78.5,
                    "Comp_B_Current": 78.800003,
                    "Comp_C_Current": 79.5,
                    "Current_Draw": 78.800003,
                    "Demand_Limit_SP": 95,
                    "EVAP_SAT_Pressure": 261.312927,
                    "EVAP_SAT_Temp": 6.054951,
                    "Running_Current": 0,
                    "CHW_Valve_Control": 1,
                    "CHW_Valve_Sta": 1,
                    "Control": 1,
                    "Priority": 1
                },
                "CH_4": {
                    "CDWR_Temp": 32.218998,
                    "CDWS_Temp": 36.218597,
                    "CDW_Valve_Sta": 1,
                    "CHWR_Temp": 11.05445,
                    "CHWST_SP": 10,
                    "CHWST_SP_Control": 10,
                    "CHWS_Temp": 8.4436,
                    "CHW_Valve_Sta": 1,
                    "COND_SAT_Pressure": 866.676392,
                    "COND_SAT_Temp": 38.107296,
                    "Comp_A_Current": 61.799999,
                    "Comp_B_Current": 63.900002,
                    "Comp_C_Current": 61.099998,
                    "Current_Draw": 62.099998,
                    "Demand_Limit_SP": 97,
                    "EVAP_SAT_Pressure": 286.134216,
                    "EVAP_SAT_Temp": 7.943649,
                    "Running_Current": 187.045197,
                    "CHW_Valve_Control": 1,
                    "Control": 1,
                    "Priority": 1
                }
            },
            "condenserPumps": {
                "CDWP_1": {
                    "Auto_Sta": 1,
                    "Control": 1,
                    "OnOff_Sta": 1,
                    "Trip": 0,
                    "Priority": 1
                },
                "CDWP_2": {
                    "Auto_Sta": 0,
                    "Control": 0,
                    "OnOff_Sta": 0,
                    "Trip": 0,
                    "Priority": 2
                },
                "CDWP_3": {
                    "Auto_Sta": 0,
                    "Control": 0,
                    "OnOff_Sta": 0,
                    "Trip": 0,
                    "Priority": 3
                },
                "CDWP_4": {
                    "Auto_Sta": 1,
                    "Control": 0,
                    "OnOff_Sta": 0,
                    "Speed_Control": 600,
                    "Trip": 0,
                    "Priority": 2
                },
                "CDWP_5": {
                    "Auto_Sta": 1,
                    "Control": 1,
                    "OnOff_Sta": 1,
                    "Speed_Control": 600,
                    "Trip": 0,
                    "Priority": 1
                }
            },
            "chilledWaterPumps": {
                "CHWP_1": {
                    "Auto_Sta": 0,
                    "Control": 0,
                    "OnOff_Sta": 0,
                    "Trip": 0
                },
                "CHWP_3": {
                    "Auto_Sta": 1,
                    "Control": 1,
                    "OnOff_Sta": 1,
                    "Trip": 0
                },
                "CHWP_4": {
                    "Auto_Sta": 1,
                    "Control": 1,
                    "OnOff_Sta": 1,
                    "Trip": 0
                }
            },
            "coolingTowers": {
                "CT_1": {
                    "Auto_Sta": 1,
                    "Control": 1,
                    "In_Valve_Control": 1,
                    "In_Valve_Sta": 1,
                    "OnOff_Sta": 1,
                    "Out_Valve_Control": 1,
                    "Out_Valve_Sta": 1,
                    "Trip": 0,
                    "Priority": 1
                },
                "CT_3": {
                    "Auto_Sta": 0,
                    "Control": 0,
                    "In_Valve_Control": 0,
                    "In_Valve_Sta": 0,
                    "OnOff_Sta": 0,
                    "Out_Valve_Control": 0,
                    "Out_Valve_Sta": 0,
                    "Trip": 0,
                    "Priority": 2
                },
                "CT_4": {
                    "Auto_Sta": 1,
                    "Control": 1,
                    "OnOff_Sta": 1,
                    "Speed_Control": 1000,
                    "Trip": 0,
                    "Priority": 1
                }
            },
            "systemControls": {
                "b_Optimization_Mode": 0,
                "b_Winter_Mode": 0,
                "w_heartbeat_1": 455,
                "w_heartbeat_2": 40
            },
            "status": {
                "w_CDWP_A_Request": 1,
                "w_CDWP_B_Request": 1,
                "w_CH_A_Request": 1,
                "w_CH_B_Request": 1,
                "w_CT_A_Request": 1,
                "w_CT_B_Request": 1
            }
        };
    </script>
</body>
</html>
